<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>ãˆã„ãæ•™æãƒãƒ¼ã‚¿ãƒ«</title>
  <style>
    :root{
      --ink:#111;
      --muted:#666;
      --paper:#f6f3ee;
      --paper2:#fbfaf7;
      --wood1:#a77a46;
      --wood2:#8b5f33;
      --line: rgba(17,17,17,.18);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --r16:16px;
      --r22:22px;
      --r28:28px;
      --bw:2px;

      --sbw:320px;
      --gap:16px;
      --btnH:44px;
      --chipH:34px;

      /* âœ… è¿½åŠ ï¼šå·¦ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³åˆ†ã®é€ƒã’ */
      --openBtnSize:48px;
      --openBtnGap:14px; /* ãƒœã‚¿ãƒ³ã¨æ–‡å­—ã®é–“éš” */
      --openBtnReserve: calc(var(--openBtnSize) + var(--openBtnGap));
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(167,122,70,.18), transparent 55%),
        radial-gradient(1000px 600px at 90% 30%, rgba(17,17,17,.08), transparent 55%),
        linear-gradient(0deg, var(--paper), var(--paper2));
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* subtle paper noise */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:
        repeating-linear-gradient(45deg, rgba(0,0,0,.02) 0 2px, transparent 2px 10px);
      mix-blend-mode:multiply;
      opacity:.35;
    }

    a{color:inherit}
    button, input, textarea, select{
      font:inherit;
      color:inherit;
    }

    /* Layout */
    .app{
      height:100%;
      display:flex;
      align-items:stretch;
    }

    /* Sidebar (overlay) */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.38);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:40;
    }
    .overlay.on{opacity:1; pointer-events:auto;}

    .sidebar{
      position:fixed;
      top:0; left:0; bottom:0;
      width:var(--sbw);
      transform: translateX(-102%);
      transition: transform .22s ease;
      z-index:50;

      background:
        linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.88)),
        radial-gradient(900px 500px at 30% 0%, rgba(167,122,70,.14), transparent 60%);
      border-right: var(--bw) solid var(--ink);
      box-shadow: var(--shadow);
      padding: 14px 14px 18px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .sidebar.on{transform: translateX(0);}

    .sbTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 2px 2px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .brandIcon{
      width:38px; height:38px;
      border: var(--bw) solid var(--ink);
      border-radius: 12px;
      background:
        linear-gradient(180deg, rgba(167,122,70,.20), rgba(167,122,70,.05));
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .brandText{
      min-width:0;
      line-height:1.05;
    }
    .brandText .t{
      font-weight:900;
      font-size:16px;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .s{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sbClose{
      height:40px;
      padding:0 12px;
      border-radius: 999px;
      border: var(--bw) solid var(--ink);
      background:#fff;
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
    }
    .sbClose:active{transform: translateY(1px)}
    .sbClose .bars{
      width:14px; height:14px;
      display:grid; gap:3px;
    }
    .sbClose .bars i{
      height:2px; background:var(--ink); display:block; border-radius:2px;
    }

    .sbSection{
      border: var(--bw) solid var(--ink);
      border-radius: var(--r22);
      background: rgba(255,255,255,.92);
      overflow:hidden;
    }
    .sbSectionHeader{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.03);
      font-weight:800;
    }
    .sbSectionHeader small{color:var(--muted); font-weight:700}

    .sbList{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .sbItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: var(--bw) solid rgba(17,17,17,.22);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .sbItem.active{
      background: #111;
      color:#fff;
      border-color:#111;
    }
    .sbItem .l{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .sbItem .icon{
      width:34px; height:34px;
      border-radius: 12px;
      border: var(--bw) solid currentColor;
      display:grid; place-items:center;
      opacity:.95;
      flex:0 0 auto;
    }
    .sbItem .name{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .sbItem .name b{
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sbItem .name span{
      font-size:12px; opacity:.75;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sbItem .count{
      width:34px; height:34px;
      border-radius: 999px;
      border: var(--bw) solid currentColor;
      display:grid; place-items:center;
      font-weight:900;
      flex:0 0 auto;
      opacity:.9;
    }

    /* Main */
    .main{
      flex:1 1 auto;
      min-width:0;
      padding: 18px;
    }

    /* âœ… top-left floating open buttonï¼ˆè¢«ã‚‰ãªã„ã‚ˆã†ã«ã‚µã‚¤ã‚ºå¤‰æ•°ã‚’ä½¿ã†ï¼‰ */
    .openSB{
      position:fixed;
      top: calc(12px + env(safe-area-inset-top));
      left: calc(12px + env(safe-area-inset-left));
      z-index:30;
      width:var(--openBtnSize);
      height:var(--openBtnSize);
      border-radius: 16px;
      border: var(--bw) solid var(--ink);
      background:
        linear-gradient(180deg, rgba(167,122,70,.22), rgba(255,255,255,.75));
      box-shadow: 0 10px 26px rgba(0,0,0,.12);
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .openSB:active{transform: translateY(1px)}
    .openSB .bars{
      width:18px; height:14px;
      display:grid; gap:4px;
    }
    .openSB .bars i{
      height:2px; background:var(--ink); display:block; border-radius:2px;
    }

    /* Header (wood) */
    .header{
      border: var(--bw) solid var(--ink);
      border-radius: var(--r28);
      padding: 18px 18px 16px;

      /* âœ… ã“ã“ãŒæœ¬å‘½ï¼šå·¦ä¸Šãƒœã‚¿ãƒ³åˆ†ã®ä½™ç™½ã‚’ç¢ºä¿ã—ã¦é‡ãªã‚Šå›é¿ */
      padding-left: calc(18px + var(--openBtnReserve));

      background:
        linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,0)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 4px, transparent 4px 12px),
        linear-gradient(90deg, var(--wood1), var(--wood2));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .header:after{
      content:"";
      position:absolute; right:-80px; top:-40px;
      width:340px; height:200px;
      opacity:.22;
      background:
        radial-gradient(circle at 30% 60%, rgba(0,0,0,.25) 0 2px, transparent 3px),
        radial-gradient(circle at 55% 55%, rgba(0,0,0,.22) 0 2px, transparent 3px),
        radial-gradient(circle at 80% 60%, rgba(0,0,0,.20) 0 2px, transparent 3px);
      transform: rotate(-8deg);
      filter: blur(.2px);
      pointer-events:none;
    }

    .hTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
    }
    .hTitle{
      min-width: 280px;
    }
    .hTitle h1{
      margin:0;
      font-size: 28px;
      font-weight: 950;
      letter-spacing:.02em;
      color:#111;
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .hTitle p{
      margin: 8px 0 0;
      color: rgba(0,0,0,.72);
      font-size: 13px;
      font-weight: 700;
    }

    .searchBox{
      min-width: 280px;
      flex: 1 1 360px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      align-items:center;
    }
    .search{
      flex: 1 1 auto;
      max-width: 520px;
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.92);
      border: var(--bw) solid var(--ink);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    .search .glass{
      width:18px; height:18px;
      border: var(--bw) solid var(--ink);
      border-radius: 999px;
      position:relative;
      flex:0 0 auto;
    }
    .search .glass:after{
      content:"";
      position:absolute;
      width:10px; height:2px;
      background:var(--ink);
      right:-8px; bottom:-4px;
      transform: rotate(45deg);
      border-radius:2px;
    }
    .search input{
      border:0; outline:none;
      background:transparent;
      width:100%;
      font-size:14px;
      font-weight:800;
    }

    .btn{
      height: var(--btnH);
      padding: 0 14px;
      border-radius: 999px;
      border: var(--bw) solid var(--ink);
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
      box-shadow: 0 12px 22px rgba(0,0,0,.18);
    }
    .btn:active{transform: translateY(1px)}
    .btn .plus{
      width:16px; height:16px;
      position:relative;
    }
    .btn .plus:before, .btn .plus:after{
      content:"";
      position:absolute; left:50%; top:50%;
      width:14px; height:2px;
      background: currentColor;
      transform: translate(-50%,-50%);
      border-radius:2px;
    }
    .btn .plus:after{transform: translate(-50%,-50%) rotate(90deg)}

    /* Filters row */
    .filters{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      height: var(--chipH);
      padding: 0 14px;
      border-radius: 999px;
      border: var(--bw) solid var(--ink);
      background: rgba(255,255,255,.90);
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .chip.on{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    /* Content area */
    .content{
      margin-top: 14px;
      border: var(--bw) solid var(--ink);
      border-radius: var(--r28);
      background: rgba(255,255,255,.55);
      padding: 14px;
      box-shadow: var(--shadow);
      min-height: calc(100vh - 220px);
    }

    .metaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .metaBadge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: var(--bw) solid rgba(17,17,17,.20);
      background: rgba(255,255,255,.85);
      font-weight:900;
      color: rgba(0,0,0,.80);
    }

    /* Cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      border: var(--bw) solid var(--ink);
      border-radius: var(--r28);
      background: rgba(255,255,255,.82);
      overflow:hidden;
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      display:flex;
      min-height: 180px;
    }

    .thumb{
      width: 220px;
      min-width: 220px;
      background:
        radial-gradient(420px 220px at 30% 20%, rgba(167,122,70,.22), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.06), rgba(0,0,0,0));
      border-right: 1px solid var(--line);
      position:relative;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:.96;
      filter: saturate(.9) contrast(1.02);
    }
    .thumb .ph{
      display:grid;
      place-items:center;
      width:100%;
      height:100%;
      padding: 14px;
      color: rgba(0,0,0,.72);
      font-weight:950;
      letter-spacing:.02em;
      font-size: 18px;
      text-align:center;
      line-height:1.2;
    }
    .thumb .tagTop{
      position:absolute;
      top:10px; left:10px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding: 0 10px;
      height: 30px;
      border-radius: 999px;
      border: var(--bw) solid rgba(17,17,17,.25);
      background: rgba(255,255,255,.88);
      font-weight:900;
      font-size: 12px;
      white-space:nowrap;
    }

    .cardBody{
      flex:1 1 auto;
      padding: 14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }
    .cardTitle{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:.01em;
    }
    .cardDesc{
      margin:0;
      color: rgba(0,0,0,.72);
      font-size: 13px;
      font-weight: 800;
      line-height:1.45;
    }
    .chipsRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 2px;
    }
    .miniChip{
      display:inline-flex;
      align-items:center;
      height: 30px;
      padding: 0 12px;
      border-radius: 999px;
      border: var(--bw) solid rgba(17,17,17,.18);
      background: rgba(0,0,0,.04);
      font-weight:900;
      font-size: 12px;
      color: rgba(0,0,0,.78);
    }

    .cardBottom{
      margin-top:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .idText{
      color: rgba(0,0,0,.55);
      font-size:12px;
      font-weight:800;
    }
    .cardActions{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .btnSmall{
      height: 44px;
      padding: 0 14px;
      border-radius: 999px;
      border: var(--bw) solid var(--ink);
      background:#fff;
      cursor:pointer;
      font-weight:950;
      user-select:none;
    }
    .btnSmall.primary{
      background:#111; color:#fff; border-color:#111;
    }
    .btnSmall.danger{
      background: #fff;
      border-color: rgba(0,0,0,.35);
    }
    .btnSmall:active{transform: translateY(1px)}

    /* Player modal */
    .player{
      position:fixed; inset:0;
      z-index:80;
      display:none;
    }
    .player.on{display:block;}
    .player .bg{
      position:absolute; inset:0;
      background: rgba(0,0,0,.60);
    }
    .player .panel{
      position:absolute; inset: 14px;
      border-radius: 26px;
      border: var(--bw) solid #111;
      background: #fff;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .playerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      background:
        linear-gradient(180deg, rgba(167,122,70,.22), rgba(0,0,0,0)),
        linear-gradient(90deg, #faf7f1, #fff);
      border-bottom: 1px solid var(--line);
    }
    .playerTop .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .playerTop .title{
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: min(64vw, 800px);
    }
    .playerTop .right{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .player iframe{
      border:0;
      width:100%;
      height:100%;
      background:#fff;
    }

    /* Create drawer (in main area) */
    .drawer{
      display:none;
      margin-top: 12px;
      border: var(--bw) solid var(--ink);
      border-radius: var(--r28);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .drawer.on{display:block;}
    .drawerHead{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.03);
      border-bottom: 1px solid var(--line);
    }
    .drawerHead b{font-weight:950}
    .drawerBody{
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .drawerBody{grid-template-columns: 1fr;}
      .thumb{width: 180px; min-width:180px;}
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .field label{
      font-weight:950;
      font-size: 13px;
      color: rgba(0,0,0,.82);
    }
    .field input, .field select, .field textarea{
      border: var(--bw) solid rgba(17,17,17,.25);
      border-radius: 16px;
      padding: 10px 12px;
      background: #fff;
      outline:none;
      font-weight:850;
    }
    .field textarea{min-height: 110px; resize:vertical; font-weight:800;}
    .hint{
      font-size: 12px;
      color: rgba(0,0,0,.62);
      font-weight:800;
      line-height:1.35;
    }
    .rowSpan2{grid-column: 1 / -1;}

    .drawerFoot{
      padding: 12px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      border-top: 1px solid var(--line);
      background: rgba(255,255,255,.75);
    }

    /* âœ… ã‚¹ãƒãƒ›å¹…ã§ã¯â€œå·¦ä½™ç™½ã‚’å¢—ã‚„ã™â€ã‚ˆã‚Šâ€œä¸Šã«é€ƒãŒã™â€æ–¹ãŒå®‰å…¨ */
    @media (max-width: 720px){
      .header{
        padding-left: 18px;
        padding-top: calc(18px + var(--openBtnReserve));
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .sidebar, .overlay{transition:none}
      .openSB:active, .btn:active, .btnSmall:active, .sbClose:active{transform:none}
    }
  </style>
</head>
<body>
  <!-- âœ… divâ†’buttonï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼‰ -->
  <button class="openSB" id="openSB" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
    <div class="bars" aria-hidden="true"><i></i><i></i><i></i></div>
  </button>

  <div class="overlay" id="overlay"></div>

  <aside class="sidebar" id="sidebar" aria-label="ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
    <div class="sbTop">
      <div class="brand">
        <div class="brandIcon" aria-hidden="true">ğŸ§°</div>
        <div class="brandText">
          <div class="t">ãˆã„ãæ•™æãƒãƒ¼ã‚¿ãƒ«</div>
          <div class="s">æ•™ç§‘â†’å˜å…ƒã§çµã‚Šè¾¼ã¿</div>
        </div>
      </div>
      <button class="sbClose" id="closeSB">
        <span class="bars" aria-hidden="true"><i></i><i></i><i></i></span>
        <span>é–‰ã˜ã‚‹</span>
      </button>
    </div>

    <div class="sbSection">
      <div class="sbSectionHeader">
        <span>ãƒšãƒ¼ã‚¸</span><small>æ“ä½œ</small>
      </div>
      <div class="sbList">
        <div class="sbItem active" id="navList">
          <div class="l">
            <div class="icon" aria-hidden="true">â‰¡</div>
            <div class="name">
              <b>ä¸€è¦§</b><span>æ•™æã‚’æ¢ã™</span>
            </div>
          </div>
          <div class="count" id="countAll">0</div>
        </div>
        <div class="sbItem" id="navCreate">
          <div class="l">
            <div class="icon" aria-hidden="true">ï¼‹</div>
            <div class="name">
              <b>ä½œæˆ</b><span>ã“ã®ç«¯æœ«ã«ä¿å­˜</span>
            </div>
          </div>
          <div class="count" id="countCustom">0</div>
        </div>
      </div>
    </div>

    <div class="sbSection">
      <div class="sbSectionHeader">
        <span>æ•™ç§‘</span><small id="sbSubjectHint">ã™ã¹ã¦</small>
      </div>
      <div class="sbList" id="subjectList"></div>
    </div>

    <div class="sbSection">
      <div class="sbSectionHeader">
        <span>å˜å…ƒ</span><small id="sbUnitHint">æ•™ç§‘ã‚’é¸ã¶</small>
      </div>
      <div class="sbList" id="unitList"></div>
    </div>
  </aside>

  <main class="main">
    <section class="header">
      <div class="hTop">
        <div class="hTitle">
          <h1>ãˆã„ãæ•™æãƒãƒ¼ã‚¿ãƒ«</h1>
          <p>ã‚«ãƒ¼ãƒ‰ã‚’æŠ¼ã—ã¦æ•™æã‚’é–‹ãï¼ˆåŒä¸€ã‚µã‚¤ãƒˆå†…ã¯å…¨ç”»é¢ã§è¡¨ç¤ºï¼‰</p>
        </div>
        <div class="searchBox">
          <div class="search" role="search">
            <span class="glass" aria-hidden="true"></span>
            <input id="q" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šæ•°é‡ / æ•°å”± / åˆæˆåˆ†è§£ / ã‹ãŸã¡ï¼‰" />
          </div>
          <button class="btn primary" id="btnCreateTop">
            <span class="plus" aria-hidden="true"></span>
            <span>ä½œæˆ</span>
          </button>
          <button class="btn" id="btnResetTop">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>

      <div class="filters" id="topChips"></div>
    </section>

    <section class="drawer" id="drawer">
      <div class="drawerHead">
        <b>ä½œæˆï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰</b>
        <button class="btnSmall" id="drawerClose">é–‰ã˜ã‚‹</button>
      </div>
      <div class="drawerBody">
        <div class="field">
          <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="fTitle" placeholder="ä¾‹ï¼šæ•°é‡ã‚²ãƒ¼ãƒ ãƒ»ã„ãã¤ï¼Ÿ" />
        </div>
        <div class="field">
          <label>æ•™ç§‘</label>
          <select id="fSubject"></select>
        </div>

        <div class="field">
          <label>å˜å…ƒ</label>
          <input id="fUnit" placeholder="ä¾‹ï¼šæ•°é‡ / æ•°å”± / åˆæˆåˆ†è§£ / SST ãªã©" />
        </div>
        <div class="field">
          <label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
          <input id="fTags" placeholder="ä¾‹ï¼šå°å…¥, ã‚²ãƒ¼ãƒ , 2æŠ" />
        </div>

        <div class="field rowSpan2">
          <label>èª¬æ˜</label>
          <textarea id="fDesc" placeholder="ä½•ã®æ•™æã‹ã‚’çŸ­ãã€‚"></textarea>
        </div>

        <div class="field">
          <label>ç™»éŒ²ã‚¿ã‚¤ãƒ—</label>
          <select id="fType">
            <option value="url">URLã‚’ç™»éŒ²ï¼ˆãŠã™ã™ã‚ï¼‰</option>
            <option value="html">HTMLã‚³ãƒ¼ãƒ‰ã‚’è²¼ã£ã¦ä¿å­˜ï¼ˆç«¯æœ«å†…ã®ã¿ï¼‰</option>
          </select>
          <div class="hint">
            â€»ã€ŒChatGPTã§ç·¨é›†ã€ãƒãƒ¼ã‚’å‡ºã•ãªã„ãªã‚‰ã€æ•™æã‚’GitHubã«ç½®ã„ãŸURLï¼ˆåŒä¸€ã‚µã‚¤ãƒˆURLï¼‰ãŒãŠã™ã™ã‚ã€‚<br/>
            â€»HTMLè²¼ã‚Šä»˜ã‘ã¯ã€Œå˜ä¸€HTMLç‰ˆã€ã ã‘å‹•ãã¾ã™ï¼ˆReactã®ã¾ã¾è²¼ã£ã¦ã‚‚å‹•ã‹ãªã„ã“ã¨ãŒå¤šã„ï¼‰ã€‚
          </div>
        </div>

        <div class="field" id="urlBlock">
          <label>URL</label>
          <input id="fUrl" placeholder="ä¾‹ï¼š./tools/math-quantity-001/index.htmlï¼ˆåŒä¸€ã‚µã‚¤ãƒˆã ã¨å…¨ç”»é¢ã§é–‹ã‘ã‚‹ï¼‰" />
        </div>

        <div class="field rowSpan2" id="htmlBlock" style="display:none;">
          <label>HTMLã‚³ãƒ¼ãƒ‰</label>
          <textarea id="fHtml" placeholder="<!doctype html> ã‹ã‚‰ã¾ã‚‹ã”ã¨è²¼ã‚Šä»˜ã‘"></textarea>
          <div class="hint">â€»ç«¯æœ«å†…ä¿å­˜ãªã®ã§ã€åˆ¥ç«¯æœ«ãƒ»ä»–ã®å…ˆç”Ÿã«ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚</div>
        </div>
      </div>

      <div class="drawerFoot">
        <button class="btnSmall" id="btnExport">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰</button>
        <label class="btnSmall" style="display:inline-flex; align-items:center; gap:10px; cursor:pointer;">
          ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </label>
        <button class="btnSmall danger" id="btnClearCustom">ç«¯æœ«ä¿å­˜ã‚’å…¨å‰Šé™¤</button>
        <button class="btnSmall primary" id="btnSave">ä¿å­˜</button>
      </div>
    </section>

    <section class="content" id="content">
      <div class="metaRow">
        <div class="metaBadge" id="metaBadge">è¡¨ç¤ºï¼š0ä»¶</div>
        <div class="metaActions"></div>
      </div>

      <div class="grid" id="grid"></div>
    </section>
  </main>

  <!-- Player -->
  <div class="player" id="player" aria-hidden="true">
    <div class="bg" id="playerBg"></div>
    <div class="panel" role="dialog" aria-modal="true">
      <div class="playerTop">
        <div class="left">
          <button class="btnSmall primary" id="playerClose">æˆ»ã‚‹</button>
          <div class="title" id="playerTitle">æ•™æ</div>
        </div>
        <div class="right">
          <button class="btnSmall" id="playerNewTab">æ–°è¦ã‚¿ãƒ–</button>
          <button class="btnSmall" id="playerCopy">URLã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
      <iframe id="playerFrame" title="æ•™æãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼"></iframe>
    </div>
  </div>

  <!-- Data -->
  <script src="./materials.js?v=2"></script>

  <script>
    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);

    const LS_CUSTOM = "tokushi_portal_custom_v1";
    const LS_HIDDEN = "tokushi_portal_hidden_v1";

    const SUBJECT_PRESETS = ["ç®—æ•°", "å›½èª", "ç”Ÿæ´»", "è‡ªç«‹æ´»å‹•", "ICTãƒ„ãƒ¼ãƒ«", "æœªåˆ†é¡"];

    function safeJsonParse(s, fallback){
      try { return JSON.parse(s); } catch(e){ return fallback; }
    }

    function nowId(prefix="m"){
      const s = Math.random().toString(36).slice(2, 6) + "-" + Math.random().toString(36).slice(2, 6);
      return prefix + "-" + s;
    }

    function isLocalUrl(url){
      if(!url) return false;
      if(url.startsWith("http://") || url.startsWith("https://")) return false;
      return true;
    }

    function normalizeUrl(url){
      if(!url) return "";
      return url.trim();
    }

    function countBy(arr, keyFn){
      const m = new Map();
      for(const it of arr){
        const k = keyFn(it);
        m.set(k, (m.get(k)||0) + 1);
      }
      return m;
    }

    // ===== State =====
    const state = {
      sidebarOpen: false,
      page: "list", // list | create
      subject: "ã™ã¹ã¦",
      unit: "ã™ã¹ã¦",
      chip: "ã™ã¹ã¦", // top chips (type)
      q: "",
      player: { open:false, current:null, lastUrl:"" },
      data: { base:[], custom:[], hidden:new Set(), allVisible:[] }
    };

    // ===== Load Data =====
    function loadBase(){
      const base = Array.isArray(window.MATERIALS) ? window.MATERIALS : [];
      return base.map(m => ({
        id: m.id || nowId("b"),
        title: m.title || "ï¼ˆç„¡é¡Œï¼‰",
        subject: m.subject || "æœªåˆ†é¡",
        unit: m.unit || "æœªåˆ†é¡",
        desc: m.desc || "",
        tags: Array.isArray(m.tags) ? m.tags : [],
        kind: m.kind || "url",
        url: m.url || "",
        thumb: m.thumb || ""
      }));
    }

    function loadCustom(){
      const list = safeJsonParse(localStorage.getItem(LS_CUSTOM), []);
      if(!Array.isArray(list)) return [];
      return list;
    }

    function saveCustom(list){
      localStorage.setItem(LS_CUSTOM, JSON.stringify(list));
    }

    function loadHidden(){
      const arr = safeJsonParse(localStorage.getItem(LS_HIDDEN), []);
      const s = new Set(Array.isArray(arr) ? arr : []);
      return s;
    }

    function saveHidden(set){
      localStorage.setItem(LS_HIDDEN, JSON.stringify(Array.from(set)));
    }

    function refreshData(){
      state.data.base = loadBase();
      state.data.custom = loadCustom();
      state.data.hidden = loadHidden();

      const merged = [...state.data.base, ...state.data.custom];

      const visible = merged.filter(m => !state.data.hidden.has(m.id));

      visible.sort((a,b)=>{
        const A = (a.subject||"") + "ï½œ" + (a.unit||"") + "ï½œ" + (a.title||"");
        const B = (b.subject||"") + "ï½œ" + (b.unit||"") + "ï½œ" + (b.title||"");
        return A.localeCompare(B, "ja");
      });

      state.data.allVisible = visible;
      $("countAll").textContent = visible.length;

      const customCount = state.data.custom.filter(m => !state.data.hidden.has(m.id)).length;
      $("countCustom").textContent = customCount;
    }

    // ===== Sidebar open/close =====
    function setSidebar(open){
      state.sidebarOpen = open;
      $("sidebar").classList.toggle("on", open);
      $("overlay").classList.toggle("on", open);
    }

    // ===== Rendering =====
    function renderTopChips(){
      const chips = [
        {id:"ã™ã¹ã¦", label:"ã™ã¹ã¦"},
        {id:"å˜å…ƒ", label:"å˜å…ƒ"},
        {id:"ãƒãƒ¼ã‚¿ãƒ«", label:"ãƒãƒ¼ã‚¿ãƒ«"},
        {id:"ãƒ„ãƒ¼ãƒ«", label:"ãƒ„ãƒ¼ãƒ«"},
        {id:"ä½œæˆ", label:"ä½œæˆ"}
      ];
      const el = $("topChips");
      el.innerHTML = "";
      for(const c of chips){
        const b = document.createElement("button");
        b.className = "chip" + (state.chip === c.id ? " on" : "");
        b.textContent = c.label;
        b.onclick = () => { state.chip = c.id; state.page="list"; $("drawer").classList.remove("on"); renderAll(); };
        el.appendChild(b);
      }
    }

    function renderSubjectList(){
      const listEl = $("subjectList");
      listEl.innerHTML = "";

      const all = state.data.allVisible;

      const subjects = new Set(SUBJECT_PRESETS);
      all.forEach(m => subjects.add(m.subject || "æœªåˆ†é¡"));

      const subjectCounts = countBy(all, m => m.subject || "æœªåˆ†é¡");

      const makeItem = (name, iconText, count, active) => {
        const it = document.createElement("div");
        it.className = "sbItem" + (active ? " active" : "");
        it.innerHTML = `
          <div class="l">
            <div class="icon" aria-hidden="true">${iconText}</div>
            <div class="name">
              <b>${name}</b><span>${name==="ã™ã¹ã¦" ? "å…¨æ•™æ" : "ã“ã®æ•™ç§‘ã ã‘"}</span>
            </div>
          </div>
          <div class="count">${count}</div>
        `;
        it.onclick = () => {
          state.subject = name;
          state.unit = "ã™ã¹ã¦";
          state.page="list";
          $("drawer").classList.remove("on");
          renderAll();
          setSidebar(false);
        };
        return it;
      };

      listEl.appendChild(makeItem("ã™ã¹ã¦", "ğŸ“š", all.length, state.subject==="ã™ã¹ã¦"));

      const sorted = Array.from(subjects).filter(s=>s!=="ã™ã¹ã¦").sort((a,b)=>a.localeCompare(b,"ja"));
      for(const s of sorted){
        const c = subjectCounts.get(s) || 0;
        if(c<=0) continue;
        const icon = (s==="ç®—æ•°")?"ğŸ§®":(s==="å›½èª")?"ğŸˆ":(s==="ç”Ÿæ´»")?"ğŸ¡":(s==="è‡ªç«‹æ´»å‹•")?"ğŸ§ ":(s==="ICTãƒ„ãƒ¼ãƒ«")?"ğŸ§°":"ğŸ“Œ";
        listEl.appendChild(makeItem(s, icon, c, state.subject===s));
      }

      $("sbSubjectHint").textContent = state.subject;
    }

    function renderUnitList(){
      const el = $("unitList");
      el.innerHTML = "";
      const all = state.data.allVisible;

      if(state.subject === "ã™ã¹ã¦"){
        $("sbUnitHint").textContent = "æ•™ç§‘ã‚’é¸ã¶";
        const note = document.createElement("div");
        note.style.padding = "10px 12px";
        note.style.color = "rgba(0,0,0,.65)";
        note.style.fontWeight = "850";
        note.style.fontSize = "12px";
        note.textContent = "æ•™ç§‘ã‚’é¸ã¶ã¨å˜å…ƒãŒå‡ºã¾ã™";
        el.appendChild(note);
        return;
      }

      const filtered = all.filter(m => (m.subject||"æœªåˆ†é¡") === state.subject);
      const unitCounts = countBy(filtered, m => m.unit || "æœªåˆ†é¡");
      const units = Array.from(unitCounts.keys()).sort((a,b)=>a.localeCompare(b,"ja"));

      const make = (name, count, active) => {
        const it = document.createElement("div");
        it.className = "sbItem" + (active ? " active" : "");
        it.innerHTML = `
          <div class="l">
            <div class="icon" aria-hidden="true">â–¦</div>
            <div class="name">
              <b>${name}</b><span>${name==="ã™ã¹ã¦" ? "å…¨å˜å…ƒ" : "ã“ã®å˜å…ƒã ã‘"}</span>
            </div>
          </div>
          <div class="count">${count}</div>
        `;
        it.onclick = () => {
          state.unit = name;
          state.page="list";
          $("drawer").classList.remove("on");
          renderAll();
          setSidebar(false);
        };
        return it;
      };

      el.appendChild(make("ã™ã¹ã¦", filtered.length, state.unit==="ã™ã¹ã¦"));
      for(const u of units){
        const c = unitCounts.get(u) || 0;
        if(c<=0) continue;
        el.appendChild(make(u, c, state.unit===u));
      }

      $("sbUnitHint").textContent = state.unit;
    }

    function applyFilters(){
      const q = (state.q || "").trim().toLowerCase();
      let arr = state.data.allVisible.slice();

      if(state.subject !== "ã™ã¹ã¦"){
        arr = arr.filter(m => (m.subject||"æœªåˆ†é¡") === state.subject);
      }
      if(state.unit !== "ã™ã¹ã¦"){
        arr = arr.filter(m => (m.unit||"æœªåˆ†é¡") === state.unit);
      }

      if(state.chip !== "ã™ã¹ã¦"){
        if(state.chip === "å˜å…ƒ"){
          arr = arr.filter(m => (m.subject||"") !== "ICTãƒ„ãƒ¼ãƒ«");
        } else {
          arr = arr.filter(m => (m.tags||[]).includes(state.chip) || (m.unit||"") === state.chip || (m.subject||"") === state.chip);
        }
      }

      if(q){
        arr = arr.filter(m=>{
          const s = [
            m.title, m.subject, m.unit, m.desc,
            ...(m.tags||[])
          ].join(" ").toLowerCase();
          return s.includes(q);
        });
      }

      return arr;
    }

    function iconForKind(kind){
      if(kind==="file") return "â¬‡ï¸";
      if(kind==="inline_html") return "âŒ";
      return "â–¶ï¸";
    }

    function resolveUrl(m){
      if(m.kind === "inline_html") return "ï¼ˆHTMLä¿å­˜ï¼‰";
      return normalizeUrl(m.url || "");
    }

    function copyText(t){
      if(!t) return;
      navigator.clipboard?.writeText(t).then(()=>{
        toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }).catch(()=>{
        const ta = document.createElement("textarea");
        ta.value = t; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy");
        ta.remove();
        toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      });
    }

    let toastTimer = null;
    function toast(msg){
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position="fixed";
        el.style.bottom="14px";
        el.style.left="50%";
        el.style.transform="translateX(-50%)";
        el.style.padding="10px 14px";
        el.style.border="2px solid #111";
        el.style.borderRadius="999px";
        el.style.background="rgba(255,255,255,.94)";
        el.style.fontWeight="950";
        el.style.boxShadow="0 12px 28px rgba(0,0,0,.18)";
        el.style.zIndex="200";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.display="block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ el.style.display="none"; }, 1100);
    }

    // ===== Player =====
    function showPlayer(m, opt){
      $("playerTitle").textContent = (m.title || "æ•™æ");
      $("player").classList.add("on");
      const frame = $("playerFrame");
      frame.src = "about:blank";
      frame.removeAttribute("srcdoc");
      if(opt && opt.srcdoc){
        frame.setAttribute("srcdoc", opt.srcdoc);
      } else if(opt && opt.src){
        frame.src = opt.src;
      }
      $("player").setAttribute("aria-hidden", "false");
      state.player.open = true;
      state.player.current = m;
    }

    function openMaterial(m){
      if(m.kind === "file"){
        window.open(m.url, "_blank", "noopener");
        return;
      }
      if(m.kind === "inline_html"){
        showPlayer(m, {srcdoc: m.inlineHtml || ""});
        return;
      }
      const url = normalizeUrl(m.url || "");
      if(!url){ toast("URLãŒç©ºã§ã™"); return; }

      if(isLocalUrl(url)){
        const bust = (url.includes("?") ? "&" : "?") + "v=" + Date.now();
        showPlayer(m, {src: url + bust});
      } else {
        window.open(url, "_blank", "noopener");
      }
    }

    function closePlayer(){
      $("player").classList.remove("on");
      $("playerFrame").src = "about:blank";
      $("player").setAttribute("aria-hidden", "true");
      state.player.open = false;
      state.player.current = null;
    }

    // ===== Delete / Hide =====
    function deleteMaterial(m, isCustom){
      if(isCustom){
        const ok = confirm("ã“ã®ç«¯æœ«ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ");
        if(!ok) return;
        const next = state.data.custom.filter(x => x.id !== m.id);
        saveCustom(next);
      } else {
        const ok = confirm("ã“ã®æ•™æã‚’â€œã“ã®ç«¯æœ«ã§éè¡¨ç¤ºâ€ã«ã—ã¾ã™ã€‚OKï¼Ÿ\nï¼ˆGitHubã®ãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰");
        if(!ok) return;
        state.data.hidden.add(m.id);
        saveHidden(state.data.hidden);
      }
      refreshData();
      renderAll();
    }

    // ===== Cards =====
    function renderCards(list){
      const grid = $("grid");
      grid.innerHTML = "";

      if(list.length === 0){
        const empty = document.createElement("div");
        empty.style.gridColumn = "1 / -1";
        empty.style.padding = "28px";
        empty.style.border = "2px dashed rgba(0,0,0,.25)";
        empty.style.borderRadius = "22px";
        empty.style.background = "rgba(255,255,255,.65)";
        empty.style.fontWeight = "950";
        empty.textContent = "è¡¨ç¤ºã™ã‚‹æ•™æãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæ¡ä»¶ã‚’ã‚†ã‚‹ã‚ã¦ã­ï¼‰";
        grid.appendChild(empty);
        return;
      }

      for(const m of list){
        const card = document.createElement("div");
        card.className = "card";

        const topPills = `
          <div class="tagTop">
            <span class="pill">${(m.subject||"æœªåˆ†é¡")}</span>
            <span class="pill">${(m.unit||"æœªåˆ†é¡")}</span>
          </div>
        `;

        const thumbHtml = m.thumb
          ? `<img alt="" src="${m.thumb}"/>`
          : `<div class="ph">${(m.title||"æ•™æ").slice(0, 16)}</div>`;

        const tags = (m.tags||[]).slice(0,6).map(t=>`<span class="miniChip">${t}</span>`).join("");

        const isCustom = state.data.custom.some(x => x.id === m.id);

        card.innerHTML = `
          <div class="thumb">
            ${topPills}
            ${thumbHtml}
          </div>
          <div class="cardBody">
            <h3 class="cardTitle">${m.title || "ï¼ˆç„¡é¡Œï¼‰"}</h3>
            <p class="cardDesc">${m.desc || ""}</p>
            <div class="chipsRow">${tags}</div>
            <div class="cardBottom">
              <div class="idText">ID: ${m.id}</div>
              <div class="cardActions">
                <button class="btnSmall primary" data-act="open">${iconForKind(m.kind)} ã²ã‚‰ã</button>
                <button class="btnSmall" data-act="copy">URL</button>
                <button class="btnSmall danger" data-act="del">${isCustom ? "å‰Šé™¤" : "éè¡¨ç¤º"}</button>
              </div>
            </div>
          </div>
        `;

        card.querySelector('[data-act="open"]').onclick = () => openMaterial(m);
        card.querySelector('[data-act="copy"]').onclick = () => copyText(resolveUrl(m));
        card.querySelector('[data-act="del"]').onclick = () => deleteMaterial(m, isCustom);

        grid.appendChild(card);
      }
    }

    // ===== Create =====
    function setPage(page){
      state.page = page;
      $("navList").classList.toggle("active", page==="list");
      $("navCreate").classList.toggle("active", page==="create");
      $("drawer").classList.toggle("on", page==="create");
      if(page==="create"){
        $("drawer").scrollIntoView({behavior:"smooth", block:"start"});
      }
    }

    function renderCreateSubjectOptions(){
      const sel = $("fSubject");
      sel.innerHTML = "";
      const subjects = new Set(SUBJECT_PRESETS);
      state.data.allVisible.forEach(m => subjects.add(m.subject||"æœªåˆ†é¡"));
      const arr = Array.from(subjects).sort((a,b)=>a.localeCompare(b,"ja"));
      for(const s of arr){
        const op = document.createElement("option");
        op.value = s; op.textContent = s;
        sel.appendChild(op);
      }
      sel.value = "ç®—æ•°";
    }

    function onTypeChange(){
      const v = $("fType").value;
      $("urlBlock").style.display = (v==="url") ? "block" : "none";
      $("htmlBlock").style.display = (v==="html") ? "block" : "none";
    }

    function saveCreated(){
      const title = $("fTitle").value.trim();
      const subject = $("fSubject").value || "æœªåˆ†é¡";
      const unit = $("fUnit").value.trim() || "æœªåˆ†é¡";
      const desc = $("fDesc").value.trim();
      const tags = $("fTags").value.split(",").map(s=>s.trim()).filter(Boolean);
      const type = $("fType").value;

      if(!title){ toast("ã‚¿ã‚¤ãƒˆãƒ«ãŒå¿…è¦ã§ã™"); return; }

      let item = {
        id: nowId("m"),
        title, subject, unit, desc,
        tags,
        kind: "url",
        url: "",
        thumb: ""
      };

      if(type === "url"){
        const url = normalizeUrl($("fUrl").value);
        if(!url){ toast("URLãŒå¿…è¦ã§ã™"); return; }
        item.kind = "url";
        item.url = url;
      } else {
        const html = $("fHtml").value;
        if(!html.trim()){ toast("HTMLã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™"); return; }
        item.kind = "inline_html";
        item.inlineHtml = html;
      }

      saveCustom([...state.data.custom, item]);

      $("fTitle").value = "";
      $("fUnit").value = "";
      $("fTags").value = "";
      $("fDesc").value = "";
      $("fUrl").value = "";
      $("fHtml").value = "";

      refreshData();
      toast("ä¿å­˜ã—ã¾ã—ãŸ");
      state.subject = "ã™ã¹ã¦";
      state.unit = "ã™ã¹ã¦";
      setPage("list");
      renderAll();
    }

    function exportCustom(){
      const payload = { version: 1, exportedAt: new Date().toISOString(), custom: state.data.custom };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "tokushi-portal-custom.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importCustom(file){
      const reader = new FileReader();
      reader.onload = () => {
        const obj = safeJsonParse(reader.result, null);
        if(!obj || !Array.isArray(obj.custom)){ toast("JSONå½¢å¼ãŒé•ã„ã¾ã™"); return; }
        const merged = [...state.data.custom, ...obj.custom];
        const map = new Map();
        for(const m of merged){ map.set(m.id || nowId("m"), m); }
        saveCustom(Array.from(map.values()));
        refreshData(); renderAll(); toast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
      };
      reader.readAsText(file);
    }

    function clearCustom(){
      const ok = confirm("ã“ã®ç«¯æœ«ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆä½œæˆåˆ†ï¼‰ã‚’å…¨éƒ¨å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ");
      if(!ok) return;
      saveCustom([]);
      refreshData(); renderAll(); toast("å‰Šé™¤ã—ã¾ã—ãŸ");
    }

    // ===== Render All =====
    function renderAll(){
      renderTopChips();
      renderSubjectList();
      renderUnitList();
      const list = applyFilters();
      $("metaBadge").textContent = `è¡¨ç¤ºï¼š${list.length}ä»¶`;
      renderCards(list);
    }

    // ===== Bind events =====
    function bind(){
      $("openSB").onclick = () => setSidebar(true);
      $("closeSB").onclick = () => setSidebar(false);
      $("overlay").onclick = () => setSidebar(false);

      $("navList").onclick = () => { setPage("list"); renderAll(); setSidebar(false); };
      $("navCreate").onclick = () => { setPage("create"); renderAll(); setSidebar(false); };

      $("btnCreateTop").onclick = () => { setPage("create"); renderAll(); };
      $("drawerClose").onclick = () => { setPage("list"); renderAll(); };

      $("btnResetTop").onclick = () => {
        state.subject="ã™ã¹ã¦"; state.unit="ã™ã¹ã¦"; state.q=""; state.chip="ã™ã¹ã¦";
        $("q").value = "";
        setPage("list");
        renderAll();
        toast("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
      };

      $("q").addEventListener("input", (e)=>{
        state.q = e.target.value;
        renderAll();
      });

      $("fType").onchange = onTypeChange;
      onTypeChange();

      $("btnSave").onclick = saveCreated;
      $("btnExport").onclick = exportCustom;
      $("importFile").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(f) importCustom(f);
        e.target.value = "";
      });
      $("btnClearCustom").onclick = clearCustom;

      // Player
      $("playerClose").onclick = closePlayer;
      $("playerBg").onclick = closePlayer;
      $("playerNewTab").onclick = ()=>{
        const m = state.player.current;
        if(!m) return;
        if(m.kind === "inline_html"){ toast("HTMLä¿å­˜ã¯æ–°è¦ã‚¿ãƒ–ã«ã§ãã¾ã›ã‚“"); return; }
        const url = normalizeUrl(m.url || "");
        if(url) window.open(url, "_blank", "noopener");
      };
      $("playerCopy").onclick = ()=>{
        const m = state.player.current;
        if(!m) return;
        if(m.kind === "inline_html"){ toast("HTMLä¿å­˜ã¯URLãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        copyText(normalizeUrl(m.url||""));
      };
      window.addEventListener("keydown", (e)=>{
        if(e.key==="Escape" && state.player.open) closePlayer();
      });
    }

    // ===== Init =====
    (function init(){
      refreshData();
      bind();
      renderCreateSubjectOptions();
      renderAll();
      setSidebar(false);
    })();
  </script>
</body>
</html>
