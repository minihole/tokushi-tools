<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>えいき教材ポータル</title>
  <style>
    :root{
      --paper:#f6f2ea;
      --paper2:#fbf9f4;
      --ink:#141414;
      --sub:#5a5a5a;
      --line:#1a1a1a;
      --lineSoft:rgba(20,20,20,.14);

      --woodA:#c09362;
      --woodB:#a87442;

      --radius:16px;
      --shadow:0 12px 28px rgba(0,0,0,.10);
      --shadow2:0 7px 18px rgba(0,0,0,.08);

      /* Safari風：左の細いアイコン列 */
      --sbW:300px;
      --sbCollapsedW:64px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN",
        "Noto Sans JP","Yu Gothic","Meiryo",sans-serif;
      background: linear-gradient(180deg, var(--paper2), var(--paper));
      overflow-x:hidden;
    }

    /* ほんのり紙質（控えめ） */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 15% 10%, rgba(0,0,0,.03), transparent 34%),
        radial-gradient(circle at 80% 20%, rgba(0,0,0,.02), transparent 30%),
        repeating-radial-gradient(circle at 25% 30%,
          rgba(0,0,0,.016) 0 1px,
          transparent 1px 7px);
      opacity:.40;
      mix-blend-mode:multiply;
    }

    /* ===== App layout ===== */
    .app{
      min-height:100vh;
      display:flex;
      align-items:stretch;
      position:relative;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width: var(--sbW);
      height:100vh;
      position:sticky;
      top:0;
      z-index:20;
      border-right:2px solid var(--line);
      background: rgba(255,255,255,.74);
      backdrop-filter: blur(10px);
      box-shadow: 10px 0 30px rgba(0,0,0,.05);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .sbHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 10px;
      border-bottom:2px solid rgba(0,0,0,.10);
    }

    .sbBrand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .sbLogo{
      width:40px; height:40px;
      border:2px solid var(--line);
      border-radius: 12px;
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 10px, rgba(0,0,0,.03) 10px 16px),
        linear-gradient(135deg, var(--woodA), var(--woodB));
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }

    .sbTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .sbTitle b{
      font-size:14px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sbTitle span{
      font-size:12px;
      color:rgba(0,0,0,.58);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sbBtn{
      border:2px solid var(--line);
      background: rgba(255,255,255,.90);
      border-radius: 999px;
      padding:8px 10px;
      font-weight:950;
      cursor:pointer;
      box-shadow: var(--shadow2);
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .sbBtn:hover{ transform: translateY(-1px); }
    .sbBtn:active{ transform: translateY(0px); }

    .sbBody{
      padding:12px 10px 14px;
      overflow:auto;
    }

    .sbSection{
      margin-top:10px;
      padding-top:10px;
      border-top:2px solid rgba(0,0,0,.10);
    }

    .sbSectionTitle{
      font-size:12px;
      font-weight:950;
      color:rgba(0,0,0,.65);
      letter-spacing:.04em;
      padding:0 6px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .sbList{ display:flex; flex-direction:column; gap:8px; }

    .sbItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius: 14px;
      border:2px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.92);
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .sbItem:hover{ transform: translateY(-1px); }

    .sbItem.active{
      background: rgba(0,0,0,.90);
      color:#fff;
      border-color: var(--line);
    }

    .sbLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .sbIcon{
      width:36px; height:36px;
      border-radius: 12px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.90);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      box-shadow: var(--shadow2);
    }
    .sbItem.active .sbIcon{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.65);
    }

    .sbText{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .sbText b{
      font-size:14px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sbText span{
      font-size:12px;
      color:rgba(0,0,0,.58);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sbItem.active .sbText span{ color:rgba(255,255,255,.72); }

    .sbCount{
      flex:0 0 auto;
      font-size:12px;
      font-weight:950;
      padding:6px 10px;
      border-radius: 999px;
      border:2px solid rgba(0,0,0,.22);
      background: rgba(255,255,255,.82);
      color: rgba(0,0,0,.80);
    }
    .sbItem.active .sbCount{
      border-color: rgba(255,255,255,.55);
      background: rgba(255,255,255,.12);
      color:#fff;
    }

    /* ===== Collapsed (Safariの左アイコン列風) ===== */
    .app.sb-collapsed .sidebar{
      width: var(--sbCollapsedW);
    }
    .app.sb-collapsed .sbTitle,
    .app.sb-collapsed .sbSectionTitle span,
    .app.sb-collapsed .sbText,
    .app.sb-collapsed .sbCount{
      display:none;
    }
    .app.sb-collapsed .sbBody{
      padding:10px 8px;
    }
    .app.sb-collapsed .sbItem{
      justify-content:center;
      padding:10px 8px;
    }
    .app.sb-collapsed .sbLeft{ gap:0; }
    .app.sb-collapsed .sbIcon{
      width:42px; height:42px;
      border-radius: 14px;
    }
    .app.sb-collapsed .sbBtn span{ display:none; }

    /* ===== Main ===== */
    .main{ flex:1 1 auto; min-width:0; }
    .wrap{ max-width: 1160px; margin:0 auto; padding:16px 18px; }

    header{
      position:sticky;
      top:0;
      z-index:15;
      border-bottom:2px solid var(--line);
      background: rgba(246,242,234,.88);
      backdrop-filter: blur(10px);
    }

    .woodbar{
      position: relative;
      border:2px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: var(--shadow2);
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 10px, rgba(0,0,0,.03) 10px 16px),
        linear-gradient(135deg, var(--woodA), var(--woodB));
    }
    .woodbar::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(140px 60px at 20% 40%, rgba(0,0,0,.10), transparent 70%),
        radial-gradient(180px 70px at 65% 70%, rgba(0,0,0,.08), transparent 72%);
      opacity:.50;
      mix-blend-mode:multiply;
    }

    .headInner{
      position:relative;
      padding: 14px 14px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 260px;
    }
    h1{
      margin:0;
      font-size:22px;
      font-weight:950;
      letter-spacing:.02em;
      line-height:1.1;
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .note{
      font-size:13px;
      color: rgba(0,0,0,.76);
      max-width: 560px;
    }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .miniBtn{
      border:2px solid var(--line);
      background: rgba(255,255,255,.90);
      border-radius: 999px;
      padding:8px 10px;
      font-weight:950;
      cursor:pointer;
      box-shadow: var(--shadow2);
      display:none; /* mobile only */
      align-items:center;
      gap:8px;
      user-select:none;
    }

    .search{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:2px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      min-width: 280px;
    }
    .search input{
      border:none; outline:none;
      width:100%;
      font-size:14px;
      background:transparent;
      color: var(--ink);
    }
    .search input::placeholder{ color: rgba(0,0,0,.55); }

    main .wrap{ padding-top:18px; padding-bottom:28px; }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .pill{
      font-size:13px;
      color: var(--sub);
      padding: 6px 10px;
      border-radius: 12px;
      border: 2px solid rgba(0,0,0,.16);
      background: rgba(255,255,255,.78);
      font-weight:900;
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .chip{
      border:2px solid var(--line);
      background: rgba(255,255,255,.86);
      color: var(--ink);
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
      transition: transform .12s ease, background .12s ease;
    }
    .chip:hover{ transform: translateY(-1px); }
    .chip.active{
      background: rgba(0,0,0,.90);
      color:#fff;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border:2px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 230px;
    }

    .thumb{
      height: 124px;
      border-bottom:2px solid var(--line);
      background:
        repeating-linear-gradient(135deg, rgba(0,0,0,.04) 0 10px, rgba(0,0,0,0) 10px 18px),
        rgba(255,255,255,.90);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .thumb img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      filter: contrast(105%) saturate(95%);
    }
    .fallback{
      width:92%;
      height:76%;
      border-radius: 14px;
      border:2px dashed rgba(0,0,0,.32);
      background: rgba(255,255,255,.80);
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:10px;
      font-weight:950;
      color: rgba(0,0,0,.70);
      white-space:pre-line;
    }

    .body{
      padding: 12px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .titleText{
      font-size:16px;
      font-weight:950;
      line-height:1.2;
    }
    .desc{
      font-size:13px;
      color: rgba(0,0,0,.70);
      line-height:1.35;
      min-height:34px;
    }
    .meta{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tag{
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.20);
      background: rgba(255,255,255,.86);
      font-weight:950;
    }
    .tag.subject{ background: rgba(0,0,0,.90); color:#fff; border-color: var(--line); }
    .tag.unit{ border-color: rgba(0,0,0,.36); }

    .actions{
      margin-top:auto;
      padding: 10px 12px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      line-height:1;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn.primary{
      background: rgba(0,0,0,.90);
      color:#fff;
      border:2px solid var(--line);
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
    }
    .btn.ghost{
      background: rgba(255,255,255,.90);
      color: var(--ink);
      border:2px solid var(--line);
    }
    .small{
      font-size:12px;
      color: rgba(0,0,0,.55);
      font-weight:900;
      margin-left:auto;
    }

    .warn{
      border:2px solid rgba(0,0,0,.90);
      background: rgba(255,255,255,.90);
      padding:12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow2);
      margin: 12px 0;
      display:none;
      font-size:13px;
      line-height:1.4;
    }

    /* ===== Create / Viewer ===== */
    .panel{
      border:2px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding: 12px 12px;
      border-bottom:2px solid rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .panelHead b{ font-weight:950; }
    .panelBody{ padding: 12px 12px 14px; }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 820px){
      .formGrid{ grid-template-columns: 1fr; }
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      font-weight:950;
      color: rgba(0,0,0,.70);
    }
    input, select, textarea{
      border:2px solid rgba(0,0,0,.18);
      border-radius: 14px;
      padding:10px 10px;
      font-size:14px;
      background: rgba(255,255,255,.92);
      outline:none;
    }
    textarea{
      min-height: 220px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    .helpRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }

    .codeBox{
      border:2px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.92);
      border-radius: 14px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      z-index:50;
      border:2px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      padding:10px 12px;
      font-weight:950;
      display:none;
    }

    /* ===== Mobile drawer ===== */
    .overlay{ display:none; }
    @media (max-width: 920px){
      .sidebar{
        position:fixed;
        left:0; top:0;
        transform: translateX(-110%);
        transition: transform .18s ease;
        box-shadow: 18px 0 40px rgba(0,0,0,.18);
      }
      .app.sb-open .sidebar{ transform: translateX(0); }
      .overlay{
        display:none;
      }
      .app.sb-open .overlay{
        display:block;
        position:fixed;
        inset:0;
        background: rgba(0,0,0,.28);
        z-index:18;
      }
      .miniBtn{ display:inline-flex; }
    }

    @media (prefers-reduced-motion: reduce){
      .chip,.btn,.sbItem,.sidebar{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <aside class="sidebar" aria-label="サイドバー">
      <div class="sbHead">
        <div class="sbBrand">
          <div class="sbLogo" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M6 18c0-4 3-8 6-8s6 4 6 8" stroke="#141414" stroke-width="2.2" stroke-linecap="round"/>
              <path d="M12 3v7" stroke="#141414" stroke-width="2.2" stroke-linecap="round"/>
              <path d="M7 21h10" stroke="#141414" stroke-width="2.2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="sbTitle">
            <b>えいき教材ポータル</b>
            <span>教科 → 単元で移動</span>
          </div>
        </div>

        <button class="sbBtn" id="sbToggle" title="サイドバーを開閉">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="#141414" stroke-width="2.4" stroke-linecap="round"/>
          </svg>
          <span id="sbToggleText">収納</span>
        </button>
      </div>

      <div class="sbBody">
        <div class="sbSection" style="border-top:none; padding-top:0; margin-top:0;">
          <div class="sbSectionTitle">
            <span>ページ</span>
            <span></span>
          </div>
          <div class="sbList" id="sbPages"></div>
        </div>

        <div class="sbSection">
          <div class="sbSectionTitle">
            <span>教科</span>
            <span id="sbAllCount"></span>
          </div>
          <div class="sbList" id="sbSubjects"></div>
        </div>

        <div class="sbSection">
          <div class="sbSectionTitle">
            <span>単元（教科の中）</span>
            <span id="sbUnitHint"></span>
          </div>
          <div class="sbList" id="sbUnits"></div>
        </div>
      </div>
    </aside>

    <div class="main">
      <header>
        <div class="wrap">
          <div class="woodbar">
            <div class="headInner">
              <div class="title">
                <h1>えいき教材ポータル</h1>
                <div class="note">教科 → 単元でしぼりこみ → カードで開く（検索もOK）</div>
              </div>

              <div class="right">
                <button class="miniBtn" id="mobileMenu">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M4 7h16M4 12h16M4 17h16" stroke="#141414" stroke-width="2.4" stroke-linecap="round"/>
                  </svg>
                  メニュー
                </button>

                <div class="search" title="タイトル/説明/タグを検索">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#141414" stroke-width="2.4"/>
                    <path d="M16.8 16.8 21 21" stroke="#141414" stroke-width="2.4" stroke-linecap="round"/>
                  </svg>
                  <input id="q" placeholder="検索（例：数量 / 数唱 / 合成分解 / ならべ）" />
                </div>
              </div>
            </div>

            <div class="headInner" style="padding-top:0;">
              <div class="chips" id="subjectChips"></div>
              <div class="chips" id="unitChips"></div>
            </div>
          </div>
        </div>
      </header>

      <main>
        <div class="wrap">
          <div id="warn" class="warn"></div>

          <div class="row">
            <div class="pill" id="count"></div>
            <div class="chips">
              <button class="btn ghost" id="goCreate" type="button">作成</button>
            </div>
          </div>

          <div id="viewLibrary">
            <div class="grid" id="grid"></div>
          </div>

          <div id="viewCreate" style="display:none;">
            <div class="panel">
              <div class="panelHead">
                <b>教材を作成（この端末に保存 / HTMLとしてダウンロード）</b>
                <div class="chips">
                  <button class="btn ghost" id="tplBlank" type="button">テンプレ</button>
                  <button class="btn ghost" id="btnPreview" type="button">プレビュー</button>
                  <button class="btn primary" id="btnSaveLocal" type="button">保存</button>
                  <button class="btn ghost" id="btnDownload" type="button">HTML</button>
                </div>
              </div>
              <div class="panelBody">
                <div class="formGrid">
                  <label>タイトル
                    <input id="fTitle" placeholder="例：算数｜数量｜いくつ？" />
                  </label>

                  <label>教科（国語/算数…）
                    <input id="fSubject" placeholder="例：算数" list="subjectList" />
                    <datalist id="subjectList"></datalist>
                  </label>

                  <label>単元（数量/数唱…）
                    <input id="fUnit" placeholder="例：数量" list="unitList" />
                    <datalist id="unitList"></datalist>
                  </label>

                  <label>ひとこと説明
                    <input id="fDesc" placeholder="例：みほんと おなじ を えらぶ" />
                  </label>

                  <label style="grid-column: 1 / -1;">タグ（カンマ区切り）
                    <input id="fTags" placeholder="例：導入, 2〜4択, 自立活動" />
                  </label>

                  <label style="grid-column: 1 / -1;">教材HTML（ここに貼る / ここで作る）
                    <textarea id="fCode" spellcheck="false"></textarea>
                  </label>
                </div>

                <div class="helpRow">
                  <button class="btn ghost" id="btnCopySnippet" type="button">materials.js用の1行をコピー</button>
                  <button class="btn ghost" id="btnBackLibrary" type="button">もどる</button>
                </div>

                <div style="margin-top:10px;">
                  <div class="pill" style="display:inline-block;">出力（コピー用）</div>
                  <div class="codeBox" id="snippetBox">ここに materials.js 用のオブジェクトが出ます</div>
                </div>

                <div style="margin-top:10px;">
                  <div class="pill" style="display:inline-block;">プレビュー</div>
                  <div class="panel" style="margin-top:8px;">
                    <div class="panelBody" style="padding:0;">
                      <iframe id="previewFrame" style="width:100%; height:520px; border:0;" sandbox="allow-scripts allow-forms allow-pointer-lock allow-popups"></iframe>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div id="viewViewer" style="display:none;">
            <div class="panel">
              <div class="panelHead">
                <b id="viewerTitle">教材</b>
                <div class="chips">
                  <button class="btn ghost" id="viewerBack" type="button">もどる</button>
                </div>
              </div>
              <div class="panelBody" style="padding:0;">
                <iframe id="viewerFrame" style="width:100%; height:760px; border:0;" sandbox="allow-scripts allow-forms allow-pointer-lock allow-popups"></iframe>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <script src="./materials.js"></script>
  <script>
    // =============================
    // Utilities
    // =============================
    const $ = (id)=>document.getElementById(id);
    const toast = $("toast");
    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display = "none", 1600);
    }
    function safeId(){
      return "m-" + Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36).slice(2,6);
    }
    function uniq(arr){ return [...new Set(arr)].filter(Boolean); }
    function isSmallScreen(){ return window.matchMedia("(max-width: 920px)").matches; }

    // =============================
    // Data (Static + Local)
    // =============================
    const WARN = $("warn");
    const raw = window.TOKUSHI_MATERIALS;
    if (!Array.isArray(raw)) {
      WARN.style.display = "block";
      WARN.textContent =
        "materials.js が見つからない/読めない状態です。リポジトリ直下に materials.js があるか確認してください。";
    }
    const STATIC = Array.isArray(raw) ? raw : [];

    const LS_KEY = "TOKUSHI_LOCAL_MATERIALS_V1";
    function loadLocal(){
      try{
        const j = localStorage.getItem(LS_KEY);
        const arr = j ? JSON.parse(j) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveLocal(arr){
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }

    function toMaterialFromLocal(x){
      return {
        id: x.id,
        title: x.title,
        subject: x.subject,
        unit: x.unit,
        desc: x.desc,
        tags: x.tags || [],
        url: "#viewer=local:" + x.id,
        thumb: "",
        file: "",
        _local: true
      };
    }

    function getAllMaterials(){
      const local = loadLocal();
      const localsAsMat = local.map(toMaterialFromLocal);
      return [...localsAsMat, ...STATIC];
    }

    // =============================
    // UI State
    // =============================
    const app = $("app");
    const overlay = $("overlay");
    const sbToggle = $("sbToggle");
    const sbToggleText = $("sbToggleText");
    const mobileMenu = $("mobileMenu");

    const qEl = $("q");
    const subjectChips = $("subjectChips");
    const unitChips = $("unitChips");
    const grid = $("grid");
    const count = $("count");

    const sbPages = $("sbPages");
    const sbSubjects = $("sbSubjects");
    const sbUnits = $("sbUnits");
    const sbAllCount = $("sbAllCount");
    const sbUnitHint = $("sbUnitHint");

    const viewLibrary = $("viewLibrary");
    const viewCreate = $("viewCreate");
    const viewViewer = $("viewViewer");

    const goCreateBtn = $("goCreate");

    const ui = {
      collapsed: localStorage.getItem("sbCollapsed") === "1",
      openMobile: false,
    };

    const state = {
      view: "library", // library | create | viewer
      subject: "すべて",
      unit: "すべて",
      q: "",
      viewerLocalId: null,
    };

    // =============================
    // Icons (no emoji)
    // =============================
    function svgIcon(kind, stroke){
      const c = stroke || "#141414";
      if (kind === "library") return `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 4h10a2 2 0 0 1 2 2v14a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2V6a2 2 0 0 1 2-2Z" stroke="${c}" stroke-width="2.2" stroke-linejoin="round"/>
          <path d="M6 4v14" stroke="${c}" stroke-width="2.2" stroke-linecap="round"/>
        </svg>`;
      if (kind === "create") return `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5v14" stroke="${c}" stroke-width="2.4" stroke-linecap="round"/>
          <path d="M5 12h14" stroke="${c}" stroke-width="2.4" stroke-linecap="round"/>
          <path d="M7 3h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="${c}" stroke-width="2.2"/>
        </svg>`;
      return `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="${c}" stroke-width="2.2"/>
          <path d="M16.8 16.8 21 21" stroke="${c}" stroke-width="2.2" stroke-linecap="round"/>
        </svg>`;
    }

    // =============================
    // Sidebar behavior
    // =============================
    function closeMobileDrawer(){
      ui.openMobile = false;
      app.classList.remove("sb-open");
    }
    function openMobileDrawer(){
      ui.openMobile = true;
      app.classList.add("sb-open");
    }
    function applySidebarMode(){
      if (!isSmallScreen()){
        if (ui.collapsed) app.classList.add("sb-collapsed");
        else app.classList.remove("sb-collapsed");
        app.classList.remove("sb-open");
        ui.openMobile = false;
        sbToggleText.textContent = ui.collapsed ? "展開" : "収納";
      } else {
        app.classList.remove("sb-collapsed");
        sbToggleText.textContent = "メニュー";
      }
    }

    sbToggle.addEventListener("click", ()=>{
      if (isSmallScreen()){
        if (ui.openMobile) closeMobileDrawer();
        else openMobileDrawer();
      } else {
        ui.collapsed = !ui.collapsed;
        localStorage.setItem("sbCollapsed", ui.collapsed ? "1" : "0");
        applySidebarMode();
      }
    });

    overlay.addEventListener("click", closeMobileDrawer);
    mobileMenu.addEventListener("click", ()=> openMobileDrawer());

    window.addEventListener("resize", applySidebarMode);

    // =============================
    // Filters
    // =============================
    function subjects(all){
      return ["すべて", ...uniq(all.map(m => m.subject))];
    }
    function units(all){
      const base = all
        .filter(m => state.subject === "すべて" ? true : m.subject === state.subject)
        .map(m => m.unit);
      return ["すべて", ...uniq(base)];
    }

    function match(m){
      if (state.subject !== "すべて" && m.subject !== state.subject) return false;
      if (state.unit !== "すべて" && m.unit !== state.unit) return false;

      const q = state.q.trim().toLowerCase();
      if (!q) return true;

      const hay = [
        m.title, m.desc, m.subject, m.unit,
        ...(m.tags || [])
      ].filter(Boolean).join(" ").toLowerCase();

      return hay.includes(q);
    }

    // =============================
    // UI builders
    // =============================
    function makeChip(label, active, onClick){
      const b = document.createElement("button");
      b.className = "chip" + (active ? " active" : "");
      b.textContent = label;
      b.onclick = onClick;
      return b;
    }

    function makeSbItem({label, subtitle, countNum, active, iconKind, onClick}){
      const item = document.createElement("div");
      item.className = "sbItem" + (active ? " active" : "");
      item.onclick = onClick;

      const left = document.createElement("div");
      left.className = "sbLeft";

      const icon = document.createElement("div");
      icon.className = "sbIcon";
      icon.innerHTML = (iconKind || "library")
        ? svgIcon(iconKind, active ? "#ffffff" : "#141414")
        : svgIcon("library", active ? "#ffffff" : "#141414");

      const text = document.createElement("div");
      text.className = "sbText";
      const b = document.createElement("b");
      b.textContent = label;
      const s = document.createElement("span");
      s.textContent = subtitle || "";
      text.appendChild(b);
      text.appendChild(s);

      left.appendChild(icon);
      left.appendChild(text);

      item.appendChild(left);

      if (typeof countNum === "number"){
        const cnt = document.createElement("div");
        cnt.className = "sbCount";
        cnt.textContent = String(countNum);
        item.appendChild(cnt);
      }

      return item;
    }

    function card(m){
      const c = document.createElement("div");
      c.className = "card";

      const th = document.createElement("div");
      th.className = "thumb";

      if (m.thumb) {
        const img = document.createElement("img");
        img.src = m.thumb;
        img.alt = m.title || "教材";
        img.onerror = ()=> {
          th.innerHTML = "";
          const fb = document.createElement("div");
          fb.className = "fallback";
          fb.textContent = (m.subject || "教科") + "\n" + (m.unit || "単元");
          th.appendChild(fb);
        };
        th.appendChild(img);
      } else {
        const fb = document.createElement("div");
        fb.className = "fallback";
        fb.textContent = (m.subject || "教科") + "\n" + (m.unit || "単元");
        th.appendChild(fb);
      }

      const body = document.createElement("div");
      body.className = "body";

      const title = document.createElement("div");
      title.className = "titleText";
      title.textContent = m.title || "（無題）";

      const desc = document.createElement("div");
      desc.className = "desc";
      desc.textContent = m.desc || "";

      const meta = document.createElement("div");
      meta.className = "meta";

      const s = document.createElement("span");
      s.className = "tag subject";
      s.textContent = m.subject || "未分類";
      meta.appendChild(s);

      const u = document.createElement("span");
      u.className = "tag unit";
      u.textContent = m.unit || "単元";
      meta.appendChild(u);

      (m.tags || []).slice(0,3).forEach(t=>{
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = t;
        meta.appendChild(tag);
      });

      body.appendChild(title);
      body.appendChild(desc);
      body.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "actions";

      const open = document.createElement("a");
      open.className = "btn primary";
      open.href = m.url || "#";
      open.target = (m.url || "").startsWith("#viewer=") ? "_self" : "_blank";
      open.rel = "noopener";
      open.textContent = "ひらく";
      actions.appendChild(open);

      if (m.file) {
        const dl = document.createElement("a");
        dl.className = "btn ghost";
        dl.href = m.file;
        dl.target = "_blank";
        dl.rel = "noopener";
        dl.textContent = "資料";
        actions.appendChild(dl);
      }

      const small = document.createElement("div");
      small.className = "small";
      small.textContent = m.id ? `ID: ${m.id}` : "";
      actions.appendChild(small);

      c.appendChild(th);
      c.appendChild(body);
      c.appendChild(actions);
      return c;
    }

    // =============================
    // View switching
    // =============================
    function setView(v){
      state.view = v;

      viewLibrary.style.display = (v === "library") ? "" : "none";
      viewCreate.style.display  = (v === "create")  ? "" : "none";
      viewViewer.style.display  = (v === "viewer")  ? "" : "none";

      if (isSmallScreen()) closeMobileDrawer();
      render();
    }

    // =============================
    // Render
    // =============================
    function render(){
      const all = getAllMaterials();

      // chips
      subjectChips.innerHTML = "";
      subjects(all).forEach(s=>{
        subjectChips.appendChild(makeChip(s, state.subject===s, ()=>{
          state.subject = s;
          state.unit = "すべて";
          setView("library");
        }));
      });

      unitChips.innerHTML = "";
      units(all).forEach(u=>{
        unitChips.appendChild(makeChip(u, state.unit===u, ()=>{
          state.unit = u;
          setView("library");
        }));
      });

      // sidebar pages
      sbPages.innerHTML = "";
      sbPages.appendChild(makeSbItem({
        label:"教材一覧",
        subtitle:"カードから開く",
        countNum: null,
        active: state.view === "library",
        iconKind:"library",
        onClick: ()=> setView("library")
      }));
      sbPages.appendChild(makeSbItem({
        label:"作成",
        subtitle:"保存/HTML",
        countNum: null,
        active: state.view === "create",
        iconKind:"create",
        onClick: ()=> setView("create")
      }));

      // sidebar subjects
      sbSubjects.innerHTML = "";
      sbAllCount.textContent = `全${all.length}件`;
      const subj = subjects(all);
      subj.forEach(s=>{
        const n = all.filter(m => (s==="すべて") ? true : m.subject === s).length;
        sbSubjects.appendChild(makeSbItem({
          label: s,
          subtitle: (s==="すべて") ? "全部表示" : "この教科だけ",
          countNum: n,
          active: state.subject === s && state.view === "library",
          iconKind:"library",
          onClick: ()=>{
            state.subject = s;
            state.unit = "すべて";
            setView("library");
          }
        }));
      });

      // sidebar units
      sbUnits.innerHTML = "";
      sbUnitHint.textContent = (state.subject === "すべて") ? "教科を選ぶと絞れます" : `「${state.subject}」内`;
      const unitList = units(all);
      unitList.forEach(u=>{
        const n = all
          .filter(m => (state.subject==="すべて") ? true : m.subject === state.subject)
          .filter(m => (u==="すべて") ? true : m.unit === u).length;

        sbUnits.appendChild(makeSbItem({
          label: u,
          subtitle: (u==="すべて") ? "全部" : "この単元だけ",
          countNum: n,
          active: state.unit === u && state.view === "library",
          iconKind:"library",
          onClick: ()=>{
            state.unit = u;
            setView("library");
          }
        }));
      });

      // library list
      if (state.view === "library"){
        const list = all.filter(match);
        count.textContent = `表示：${list.length}件 / 全${all.length}件`;
        grid.innerHTML = "";
        list.forEach(m => grid.appendChild(card(m)));
      }

      // create view: update datalists
      if (state.view === "create"){
        const dlSubj = $("subjectList");
        dlSubj.innerHTML = "";
        uniq(all.map(m=>m.subject)).filter(Boolean).forEach(s=>{
          const op = document.createElement("option");
          op.value = s;
          dlSubj.appendChild(op);
        });

        const dlUnit = $("unitList");
        dlUnit.innerHTML = "";
        uniq(all.map(m=>m.unit)).filter(Boolean).forEach(u=>{
          const op = document.createElement("option");
          op.value = u;
          dlUnit.appendChild(op);
        });

        count.textContent = "作成：この端末に保存できます（ブラウザ保存）";
      }

      // viewer view handled elsewhere
    }

    // =============================
    // Search
    // =============================
    qEl.addEventListener("input", ()=>{
      state.q = qEl.value;
      if (state.view !== "library") setView("library");
      else render();
    });

    // =============================
    // Buttons
    // =============================
    goCreateBtn.addEventListener("click", ()=> setView("create"));
    $("btnBackLibrary").addEventListener("click", ()=> setView("library"));

    // =============================
    // Hash route for viewer (local)
    // =============================
    function openViewerFromHash(){
      const h = location.hash || "";
      if (!h.startsWith("#viewer=")) return false;

      const v = decodeURIComponent(h.slice("#viewer=".length));
      // local:<id>
      if (v.startsWith("local:")){
        const id = v.slice("local:".length);
        const local = loadLocal();
        const found = local.find(x => x.id === id);
        if (!found){
          showToast("この端末に保存された教材が見つかりません");
          location.hash = "";
          setView("library");
          return true;
        }
        $("viewerTitle").textContent = found.title || "教材";
        $("viewerFrame").srcdoc = found.code || "<!doctype html><html><body>（内容なし）</body></html>";
        setView("viewer");
        return true;
      }
      return false;
    }

    window.addEventListener("hashchange", openViewerFromHash);

    $("viewerBack").addEventListener("click", ()=>{
      location.hash = "";
      setView("library");
    });

    // =============================
    // Create features
    // =============================
    const fTitle = $("fTitle");
    const fSubject = $("fSubject");
    const fUnit = $("fUnit");
    const fDesc = $("fDesc");
    const fTags = $("fTags");
    const fCode = $("fCode");
    const snippetBox = $("snippetBox");
    const previewFrame = $("previewFrame");

    function buildSnippet(id){
      const title = (fTitle.value || "").trim() || "（無題）";
      const subject = (fSubject.value || "").trim() || "未分類";
      const unit = (fUnit.value || "").trim() || "単元";
      const desc = (fDesc.value || "").trim();
      const tags = (fTags.value || "").split(",").map(s=>s.trim()).filter(Boolean);

      // GitHubに載せる想定のURL例（toolsフォルダ運用）
      const suggestedUrl = `./tools/${id}/index.html`;

      return {
        id,
        title,
        subject,
        unit,
        desc,
        tags,
        url: suggestedUrl,
        thumb: "",
        file: ""
      };
    }

    function snippetText(obj){
      return `{ 
  id: "${obj.id}",
  title: "${obj.title}",
  subject: "${obj.subject}",
  unit: "${obj.unit}",
  desc: "${obj.desc}",
  tags: ${JSON.stringify(obj.tags)},
  url: "${obj.url}",
  thumb: "${obj.thumb}",
  file: "${obj.file}"
},`;
    }

    function ensureHtmlWrap(code){
      const t = (code || "").trim();
      if (!t) return "<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'></head><body></body></html>";
      // 既にHTML全文ならそのまま
      if (t.includes("<html") || t.includes("<!doctype")) return t;

      // 部品だけ貼った場合はラップ
      return `<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>${(fTitle.value||"教材").replace(/</g,"&lt;")}</title>
</head>
<body>
${t}
</body>
</html>`;
    }

    $("tplBlank").addEventListener("click", ()=>{
      const base = `<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>教材</title>
  <style>
    body{ margin:0; font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; background:#111; color:#fff; }
    .wrap{ padding:24px; max-width: 900px; margin:0 auto; }
    .card{ border:2px solid #fff3; border-radius:16px; padding:18px; background:#1a1a1a; }
    button{ font-size:18px; padding:14px 18px; border-radius:14px; border:none; font-weight:800; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 8px;">教材テンプレ</h1>
      <p style="margin:0 0 14px; opacity:.85;">ここから自由に作ってOK</p>
      <button onclick="alert('OK!')">ボタン</button>
    </div>
  </div>
</body>
</html>`;
      fCode.value = base;
      showToast("テンプレを入れました");
    });

    $("btnPreview").addEventListener("click", ()=>{
      previewFrame.srcdoc = ensureHtmlWrap(fCode.value);
      showToast("プレビュー表示");
    });

    $("btnSaveLocal").addEventListener("click", ()=>{
      const id = safeId();
      const title = (fTitle.value || "").trim() || "（無題）";
      const subject = (fSubject.value || "").trim() || "未分類";
      const unit = (fUnit.value || "").trim() || "単元";
      const desc = (fDesc.value || "").trim();
      const tags = (fTags.value || "").split(",").map(s=>s.trim()).filter(Boolean);
      const code = ensureHtmlWrap(fCode.value);

      const local = loadLocal();
      local.unshift({ id, title, subject, unit, desc, tags, code, createdAt: Date.now() });
      saveLocal(local);

      // show snippet
      const sn = buildSnippet(id);
      snippetBox.textContent = snippetText(sn);

      showToast("保存しました（この端末）");
      // ライブラリで見えるように
      setView("library");
    });

    $("btnDownload").addEventListener("click", ()=>{
      const id = safeId();
      const html = ensureHtmlWrap(fCode.value);
      const blob = new Blob([html], {type:"text/html"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      const t = (fTitle.value || "material").replace(/[\\/:*?"<>|]+/g, "_").slice(0,40);
      a.download = `${t || "material"}_${id}.html`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      // snippetも更新
      const sn = buildSnippet(id);
      snippetBox.textContent = snippetText(sn);
      showToast("HTMLを書き出しました");
    });

    $("btnCopySnippet").addEventListener("click", async ()=>{
      const id = safeId();
      const sn = buildSnippet(id);
      const txt = snippetText(sn);
      snippetBox.textContent = txt;
      try{
        await navigator.clipboard.writeText(txt);
        showToast("コピーしました");
      }catch(e){
        showToast("コピーできないので手動で選択してね");
      }
    });

    // =============================
    // Initial route + init
    // =============================
    applySidebarMode();

    // open viewer if hash set
    if (!openViewerFromHash()){
      // default view
      setView("library");
    }

    // create button should always go create
    // (already set)

  </script>
</body>
</html>
